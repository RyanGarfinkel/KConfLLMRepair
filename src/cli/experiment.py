from src.config import settings
from src.tools import syzkaller
from src.kernel import worktree
from src.models import Sample
from src.core import Kernel
from random import randint
from src.utils import log
import subprocess
import shutil
import click
import json
import os

def sample_commits(n: int, since: str) -> tuple[dict, list[Sample]]:

    all_commits = worktree.main_repo.git.rev_list('HEAD', f'--since={since}', '--no-merges').splitlines()
    total_commits = len(all_commits) - settings.runtime.COMMIT_WINDOW
    k = total_commits // n

    start = randint(0, k)

    sampling_params = {
        'total_commits': len(all_commits),
        'earliest_commit': worktree.main_repo.commit(all_commits[-1]).authored_datetime.isoformat(),
        'latest_commit': worktree.main_repo.commit(all_commits[0]).authored_datetime.isoformat(),
        'commit_window': settings.runtime.COMMIT_WINDOW,
        'k': k,
        'n': n,
        'start': start,
    }
    
    commits = [
        Sample(
            sample_dir=settings.runtime.SAMPLE_DIR + f'/sample_{i}',
            start_commit=all_commits[start + i * k + settings.runtime.COMMIT_WINDOW],
            start_commit_date=worktree.main_repo.commit(all_commits[start + i * k + settings.runtime.COMMIT_WINDOW]).committed_datetime.isoformat(),
            end_commit=all_commits[start + i * k],
            end_commit_date=worktree.main_repo.commit(all_commits[start + i * k]).committed_datetime.isoformat(),
            base_builds=False,
            base_bootsable=False,
        ) for i in range(n)
    ]

    del all_commits

    return sampling_params, commits

def make_sample(sample: Sample, kernel: Kernel) -> bool:

    sample_dir = sample.sample_dir

    if os.path.exists(sample_dir):
        shutil.rmtree(sample_dir)

    os.makedirs(sample_dir, exist_ok=True)

    # Syzkaller Base Config Generation
    log.info('Running syzkaller to generate base configuration...')

    if not syzkaller.run(kernel.src, f'{sample_dir}/base.config'):
        log.error('Failed to run syzkaller for sample generation.')
        return False
    
    sample.base_config = f'{sample_dir}/base.config'
    
    # Verifies Valid Base
    if not kernel.load_config(f'{sample_dir}/base.config'):
        log.error('Base configuration generated by syzkaller is invalid.')
        return False
    
    if not kernel.build(f'{sample_dir}/build.log'):
        log.error('Failed to build kernel with base configuration.')
        return False
    
    sample.base_builds = True
    
    if not kernel.boot(f'{sample_dir}/boot.log'):
        log.error('Failed to boot kernel with base configuration.')
        return False
    
    sample.base_boots = True
    
    log.success('Base configuration is valid and bootable.')
    
    if not kernel.make_patch(sample.start_commit, sample.end_commit, f'{sample_dir}/changes.patch'):
        log.error('Failed to create patch for sample.')
        return False
    
    sample.patch = f'{sample_dir}/changes.patch'
    
    log.success('Sample created successfully.')

    return True

def make_modified_config(sample: Sample, kernel: Kernel) -> bool:

    log.info('Running KLocalizer for inital modifification...')

    if not kernel.load_config(sample.base_config):
        log.error('Failed to load base configuration for modification.')
        return False
    
    modified_config = f'{sample.sample_dir}/modified.config'

    if not kernel.run_klocalizer(f'{sample.sample_dir}/klocalizer.log'):
        log.error('KLocalizer failed to run.')
        return False

    if not os.path.exists(f'{kernel.src}/.config'):
        log.error('KLocalizer did not produce a .config file.')
        return False
    
    shutil.copyfile(f'{kernel.src}/.config', modified_config)

    sample.modified_config = modified_config

    return True

def repair_sample(sample: Sample, model: str | None, jobs: str | None) -> bool:

    cmd = [
        'python3', '-m', 'src.scripts.repair',
        '--base', sample.base_config,
        '--modified', sample.modified_config,
        '--patch', sample.patch,
        '--kernel-src', sample.kernel_src,
        '--output', sample.sample_dir,
        '--max-iterations', str(settings.repair.MAX_ITERATIONS),
    ]

    if model:
        cmd.extend(['--model', model])

    if jobs:
        cmd.extend(['--jobs', str(jobs)])

    try:
        subprocess.run(cmd, check=True)
        return True
    except subprocess.CalledProcessError:
        log.error('Repair process failed.')
        return False
    finally:
        worktree.cleanup(sample.kernel_src)

def proccess(sample: Sample, model: str | None, jobs: str | None, skip_repair: bool) -> bool:

    kernel = Kernel.create_worktree(sample.end_commit)

    if not make_sample(sample, kernel):
        return False
    
    if not make_modified_config(sample, kernel):
        return False
    
    if not skip_repair and not repair_sample(sample, model, jobs):
        return False
    
    return True

@click.command()
@click.option('--num-samples', '-n', default=10, help='Number of samples to generate and repair.')
@click.option('--since', default='2020-01-01', help='Only consider commits since this date (YYYY-MM-DD).')
@click.option('--commit-window', '-w', default=250, help='Number of commits to include in each patch.')
@click.option('--model', '-m', default=None, help='Override the default LLM model to use for repair.')
@click.option('--max-iterations', '-i', default=5, help='Override the maximum number of iterations for the agent.')
@click.option('--jobs', '-j', default=8, help='Number of jobs to run when building the kernel, otherwise set to 8.')
@click.option('--max-threads', '-t', default=1, help='Maximum number of threads to use for sample generation and repair.')
@click.option('--skip-repair', is_flag=True, help='Skip the sample generation phase and only perform repair on existing samples.')
def main(num_samples: int, since: str, commit_window: int, model: str | None, max_iterations: int, jobs: int, max_threads: int, skip_repair: bool):

    settings.runtime.COMMIT_WINDOW = commit_window
    settings.repair.MAX_ITERATIONS = max_iterations
    settings.runtime.MAX_THREADS = max_threads

    log.info(f'Starting experiment with {num_samples} samples...')

    sampling_params, commits = sample_commits(num_samples, since)

    for i, sample in enumerate(commits):
        log.info(f'Processing sample {i + 1}/{num_samples}...')

        if not proccess(sample, model, jobs, skip_repair):
            log.error(f'Failed to process sample {i + 1}.')
            continue

        log.success(f'Sample {i + 1} processed successfully.')

        with open(f'{settings.runtime.SAMPLE_DIR}/sampling.json', 'w') as f:
            json.dump({
                'sampling_params': sampling_params,
                'samples': [s.model_dump() for s in commits]
            }, f, indent=4)

if __name__ == '__main__':
    main()
